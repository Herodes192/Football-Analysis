"""
Opponents analysis endpoints
"""
from fastapi import APIRouter, HTTPException
from typing import Optional

from services.football_api_service import get_football_api_service
from config.settings import get_settings
from utils.logger import setup_logger

router = APIRouter()
settings = get_settings()
logger = setup_logger(__name__)
football_api = get_football_api_service()


@router.get("/opponents/{team_id}/matches")
async def get_opponent_matches(team_id: int, limit: int = 10):
    """Get opponent's recent match history"""
    try:
        matches = await football_api.get_team_last_matches(
            team_id=team_id,
            limit=limit
        )
        
        return {
            "team_id": team_id,
            "matches": matches,
            "count": len(matches)
        }
    except Exception as e:
        logger.error(f"Error fetching opponent matches: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to fetch opponent matches")


@router.get("/opponents/{team_id}/statistics")
async def get_opponent_statistics(team_id: int):
    """Get opponent's season statistics"""
    try:
        stats = await football_api.get_team_statistics(
            team_id=team_id,
            league_id=settings.GIL_VICENTE_LEAGUE_ID
        )
        
        return {
            "team_id": team_id,
            "statistics": stats
        }
    except Exception as e:
        logger.error(f"Error fetching opponent statistics: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to fetch opponent statistics")


@router.get("/opponents/{team_id}/head-to-head")
async def get_head_to_head(team_id: int, last: int = 5):
    """Get head-to-head history between Gil Vicente and opponent"""
    try:
        h2h = await football_api.get_head_to_head(
            team1_id=settings.GIL_VICENTE_TEAM_ID,
            team2_id=team_id,
            last=last
        )
        
        return {
            "gil_vicente_id": settings.GIL_VICENTE_TEAM_ID,
            "opponent_id": team_id,
            "matches": h2h,
            "count": len(h2h)
        }
    except Exception as e:
        logger.error(f"Error fetching head-to-head: {str(e)}")
        raise HTTPException(status_code=500, detail="Failed to fetch head-to-head data")
